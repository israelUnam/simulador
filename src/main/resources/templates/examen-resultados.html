<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados del examen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link th:href="@{/css/app.css}" rel="stylesheet">
</head>
<body>
<header class="app-header">
    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between py-2 px-3">
            <div class="d-flex align-items-center gap-3">
                <span class="app-header-logo">SE</span>
                <span class="app-header-title d-none d-md-inline">Simulador del Examen</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-sm-block">
                    <div class="app-header-name" th:text="${userName} ?: 'Usuario'">Usuario</div>
                    <div class="app-header-email helper-text" th:text="${userEmail}">correo@ejemplo.com</div>
                </div>
                <img th:if="${userPicture}" th:src="${userPicture}" alt="Foto" class="app-header-avatar" referrerpolicy="no-referrer" loading="lazy"/>
                <a th:href="@{/examen}" class="btn btn-sm btn-outline-light">Examen</a>
                <a th:if="${puedeCargarExcel}" th:href="@{/importar-preguntas}" class="btn btn-sm btn-outline-light">Importar preguntas</a>
                <a th:href="@{/logout}" class="btn btn-sm btn-outline-light">Cerrar sesión</a>
            </div>
        </div>
    </div>
</header>
<div class="container-fluid examen-wrapper d-flex flex-column align-items-center px-3 py-4">
    <div class="row w-100 justify-content-center" style="max-width: 900px;">
        <div class="col-12">
            <div class="content-card p-4 p-md-5">
                <h1 class="h3 fw-semibold mb-2">Resultados del examen</h1>
                <p class="text-muted mb-4" th:text="${examen != null && examen.tipoExamen != null ? examen.tipoExamen.descripcion : ''}">Tema</p>
                <p class="mb-4" th:if="${examen?.fechaHoraInicio != null}">
                    <span th:text="${#temporals.format(examen.fechaHoraInicio, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                    <span th:if="${examen.minutosTranscurrido != null}" th:text="' · ' + examen.minutosTranscurrido + ' min'">· min</span>
                </p>
                <a th:href="@{/examen}" class="btn btn-outline-primary btn-sm mb-4">← Volver a mis exámenes</a>

                <div th:each="item, stat : ${examenPreguntas}" class="card mb-4">
                    <div class="card-body">
                        <h2 class="h6 fw-semibold mb-2">
                            <span th:text="${'Pregunta ' + stat.count + ' de ' + examenPreguntas.size()}">Pregunta N</span>
                            <span th:if="${item.acierto == true}" class="badge bg-success ms-2">Correcta</span>
                            <span th:if="${item.acierto == false}" class="badge bg-danger ms-2">Incorrecta</span>
                        </h2>
                        <p class="mb-3" th:text="${item.pregunta != null ? item.pregunta.pregunta : ''}">Pregunta</p>
                        <div th:if="${item.pregunta != null && item.pregunta.enrichQuestion != null && !#strings.isEmpty(item.pregunta.enrichQuestion)}"
                             class="enrich-question mb-3 small text-muted" th:utext="${item.pregunta.enrichQuestion}">enrich</div>

                        <div th:each="num : ${#numbers.sequence(1, 4)}" class="mb-2" th:with="numStr=${#numbers.formatInteger(num, 1)}, esCorrecta=${item.pregunta != null and item.pregunta.respuesta != null and item.pregunta.respuesta.trim() == numStr}, esSeleccionada=${item.respuesta != null and item.respuesta.trim() == numStr}">
                            <div class="d-flex align-items-start gap-2 py-1 px-2 rounded"
                                 th:classappend="${esCorrecta ? 'bg-success bg-opacity-25 border border-success' : (esSeleccionada and !esCorrecta ? 'bg-danger bg-opacity-25 border border-danger' : '')}">
                                <span class="fw-medium" th:text="|${numStr}.|">1.</span>
                                <span th:text="${num == 1 ? (item.pregunta != null ? item.pregunta.answer1 : '') : (num == 2 ? (item.pregunta != null ? item.pregunta.answer2 : '') : (num == 3 ? (item.pregunta != null ? item.pregunta.answer3 : '') : (item.pregunta != null ? item.pregunta.answer4 : '')))}">Opción</span>
                                <span th:if="${esCorrecta}" class="badge bg-success ms-auto">Correcta</span>
                                <span th:if="${esSeleccionada}" class="badge bg-primary ms-1">Tu respuesta</span>
                            </div>
                        </div>

                        <div th:if="${item.pregunta != null && item.pregunta.feedback != null && !#strings.isEmpty(item.pregunta.feedback)}"
                             class="mt-3 p-2 rounded bg-light border">
                            <strong class="small text-secondary">Feedback:</strong>
                            <div class="small mt-1" th:utext="${item.pregunta.feedback}">Feedback</div>
                        </div>
                    </div>
                </div>

                <a th:href="@{/examen}" class="btn btn-outline-primary btn-sm mt-2">← Volver a mis exámenes</a>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
