<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Examen en progreso</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link th:href="@{/css/app.css}" rel="stylesheet">
</head>
<body>
<header class="app-header">
    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between py-2 px-3">
            <div class="d-flex align-items-center gap-3">
                <span class="app-header-logo">SE</span>
                <span class="app-header-title d-none d-md-inline">Simulador del Examen</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-sm-block">
                    <div class="app-header-name" th:text="${userName} ?: 'Usuario'">Usuario</div>
                    <div class="app-header-email helper-text" th:text="${userEmail}">correo@ejemplo.com</div>
                </div>
                <img th:if="${userPicture}" th:src="${userPicture}" alt="Foto" class="app-header-avatar" referrerpolicy="no-referrer" loading="lazy"/>
                <a th:href="@{/examen}" class="btn btn-sm btn-outline-light">Examen</a>
                <a th:if="${puedeCargarExcel}" th:href="@{/importar-preguntas}" class="btn btn-sm btn-outline-light">Importar preguntas</a>
                <a th:href="@{/logout}" class="btn btn-sm btn-outline-light">Cerrar sesión</a>
            </div>
        </div>
    </div>
</header>
<div class="container-fluid examen-wrapper examen-en-progreso d-flex flex-column align-items-center px-3 py-4">
    <div class="row w-100 justify-content-center" style="max-width: 900px;">
        <div class="col-12">
            <div class="content-card p-4 p-md-5">
                <h1 class="h3 fw-semibold mb-4 text-white">Examen en progreso</h1>
                <p class="text-muted mb-4 text-white" th:text="${examen != null ? examen.tipoExamen?.descripcion : ''}">Tipo de examen</p>
                <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
                    <p class="text-white small mb-0" th:text="'Pregunta ' + ${numPregunta} + ' de ' + ${totalPreguntas}">Pregunta 1 de N</p>
                    <p class="text-white small mb-0" id="tiempoTranscurrido" data-inicio="" th:attr="data-inicio=${examen != null and examen.fechaHoraInicio != null ? #temporals.format(examen.fechaHoraInicio, 'yyyy-MM-dd''T''HH:mm:ss') : ''}">
                        <span class="opacity-75">Tiempo transcurrido:</span> <strong id="tiempoTranscurridoValor">00:00:00</strong>
                    </p>
                </div>

                <form th:action="@{/examen-en-progreso/responder}" method="post" id="formRespuesta">
                    <input type="hidden" name="id" th:value="${examen?.id}"/>
                    <input type="hidden" name="num" th:value="${numPregunta}"/>
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="h6 fw-semibold mb-3" th:text="${examenPregunta.pregunta.pregunta}">Pregunta</h2>
                            <div th:if="${examenPregunta.pregunta.enrichQuestion != null && !#strings.isEmpty(examenPregunta.pregunta.enrichQuestion)}" class="enrich-question mb-3 small text-muted" th:utext="${examenPregunta.pregunta.enrichQuestion}">enrich_question</div>
                            <div class="form-check mb-2" th:each="num : ${#numbers.sequence(1, 4)}"
                                 th:with="answerText=${num == 1 ? (examenPregunta.pregunta.answer1 ?: '') : (num == 2 ? (examenPregunta.pregunta.answer2 ?: '') : (num == 3 ? (examenPregunta.pregunta.answer3 ?: '') : (examenPregunta.pregunta.answer4 ?: '')))}">
                                <input class="form-check-input" type="radio" name="respuesta" th:id="'resp_' + ${num}" th:value="${num}" th:checked="${examenPregunta.respuesta != null && examenPregunta.respuesta.trim() == #numbers.formatInteger(num, 1)}"/>
                                <label class="form-check-label" th:for="'resp_' + ${num}" th:text="${answerText}">Opción</label>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
                    <div class="d-flex gap-2">
                        <button th:if="${numPregunta > 1}" type="submit" form="formRespuesta" name="irA" value="anterior" class="btn btn-primary">Regresar</button>
                        <form th:action="@{/examen-en-progreso/marcar-pendiente}" method="post" class="d-inline">
                            <input type="hidden" name="id" th:value="${examen?.id}"/>
                            <input type="hidden" name="num" th:value="${numPregunta}"/>
                            <button type="submit" th:class="${examenPregunta.preguntaPendiente == true} ? 'btn btn-warning' : 'btn btn-outline-warning'">Marcar como pendiente</button>
                        </form>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" form="formRespuesta" name="irA" value="indice" class="btn btn-primary">Ver todas las preguntas</button>
                        <button th:if="${siguiente != null}" type="submit" form="formRespuesta" name="irA" value="siguiente" class="btn btn-primary">Siguiente</button>
                        <button th:unless="${siguiente != null}" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalFinalizar">Finalizar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFinalizarLabel">Finalizar examen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                ¿Terminar el examen ahora?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formRespuesta" name="irA" value="siguiente" class="btn btn-primary" data-bs-dismiss="modal">Sí, terminar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script th:inline="javascript">
(function() {
    var el = document.getElementById('tiempoTranscurrido');
    var valorEl = document.getElementById('tiempoTranscurridoValor');
    if (!el || !valorEl) return;
    var inicioStr = el.getAttribute('data-inicio');
    if (!inicioStr) return;
    var inicio = new Date(inicioStr.replace(' ', 'T'));
    if (isNaN(inicio.getTime())) return;
    function pad(n) { return (n < 10 ? '0' : '') + n; }
    function actualizar() {
        var seg = Math.floor((Date.now() - inicio.getTime()) / 1000);
        if (seg < 0) seg = 0;
        var h = Math.floor(seg / 3600);
        var m = Math.floor((seg % 3600) / 60);
        var s = seg % 60;
        valorEl.textContent = pad(h) + ':' + pad(m) + ':' + pad(s);
    }
    actualizar();
    setInterval(actualizar, 1000);
})();
</script>
</body>
</html>
